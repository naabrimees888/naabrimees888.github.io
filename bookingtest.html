<!DOCTYPE html>
<html>
<head>
    <title>Add Event to Google Calendar</title>
</head>
<body>
    <h1>Add Event to Google Calendar</h1>
    <div id="gSignInWrapper">
        <div id="signInButton"></div>
    </div>
    <form id="eventForm" style="display:none;">
        <label for="title">Title:</label><br>
        <input type="text" id="title" name="title"><br>
        <label for="date">Date:</label><br>
        <input type="date" id="date" name="date"><br>
        <label for="time">Time:</label><br>
        <input type="time" id="time" name="time"><br>
        <label for="location">Location:</label><br>
        <input type="text" id="location" name="location"><br>
        <button type="submit">Add to Calendar</button>
    </form>

    <script>
        function onSuccess(googleUser) {
            const idToken = googleUser.getAuthResponse().id_token;
            console.log('ID Token:', idToken);

            // Hide the sign-in button
            document.getElementById('gSignInWrapper').style.display = 'none';

            // Show the event form
            document.getElementById('eventForm').style.display = 'block';
        }

        function onFailure(error) {
            console.error('Google Sign-In failed:', error);
        }

        function onSignIn(googleUser) {
            if (googleUser.isSignedIn()) {
                onSuccess(googleUser);
            } else {
                onFailure();
            }
        }

        document.getElementById('eventForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const title = formData.get('title');
            const date = formData.get('date');
            const time = formData.get('time');
            const location = formData.get('location');

            // Call function to create event
            createEvent(title, date, time, location);
        });

        function createEvent(title, date, time, location) {
            const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;

            fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'summary': title,
                    'start': {
                        'dateTime': date + 'T' + time + ':00',
                        'timeZone': 'Tallinn'
                    },
                    'end': {
                        'dateTime': date + 'T' + time + ':00',
                        'timeZone': 'Tallinn'
                    },
                    'location': location
                })
            }).then(response => {
                if (response.ok) {
                    console.log('Event created successfully');
                    alert('Event added to Google Calendar!');
                } else {
                    console.error('Error creating event:', response.statusText);
                    alert('Error adding event to Google Calendar. Please try again later.');
                }
            }).catch(error => {
                console.error('Error creating event:', error);
                alert('Error adding event to Google Calendar. Please try again later.');
            });
        }
    </script>

    <!-- Load Google API JavaScript library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // Initialize Google Sign-In
        function initGoogleSignIn() {
            const auth2 = gapi.auth2.getAuthInstance();
            if (!auth2) {
                console.log('Initializing Google Sign-In');
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: '1062970372713-ov7r58nb41bi2g1qmmm49gc655bmk9sm.apps.googleusercontent.com'
                    }).then(function(auth2) {
                        // Attach sign-in listeners
                        gapi.signin2.render('signInButton', {
                            'scope': 'profile email',
                            'width': 240,
                            'height': 50,
                            'longtitle': true,
                            'theme': 'dark',
                            'onsuccess': onSignIn,
                            'onfailure': onFailure
                        });
                    });
                });
            } else {
                console.log('Google Sign-In has already been initialized.');
            }
        }

        // Load Google Sign-In and initialize
        gapi.load('client:auth2', initGoogleSignIn);
    </script>

    <script>
        gapi.load('client:auth2', initClient);

        function initClient() {
            gapi.client.init({
                apiKey: 'AIzaSyBdz8fT3UzafG34pkIIZBekHCiSEiWoqI4',
                clientId: '1062970372713-ov7r58nb41bi2g1qmmm49gc655bmk9sm.apps.googleusercontent.com',
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                scope: 'https://www.googleapis.com/auth/calendar.events'
            }).then(function() {
                console.log('Google Calendar API initialized');
            });
        }
    </script>
</body>
</html>
